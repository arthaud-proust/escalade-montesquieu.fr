const socket=io.connect(window._push_host+"?token="+window._token);var writeTimeout=null;const months=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];try{window._last_message_author=window._messages[0].author_uuid,window._last_message_id=window._messages[0].id,localStorage.setItem(`${window._forum}.last_message`,new Date(window._messages[0].created_at).getTime())}catch(e){window._last_message_id=0}const contextMenuItems=[["Voir le profil","profile"],["Mentionner","mention"],["Mentionner tout le monde","mentionAll"]],contextMenuContent=contextMenuItems.map(e=>`<span onclick="${e[1]}()">${e[0]}</span>`).join(""),formUrlEncoded=e=>Object.keys(e).reduce((t,n)=>t+`&${n}=${encodeURIComponent(e[n])}`,"");function profile(){let e=$("#"+$("#contextMenu").attr("data-message")).find(".MessageCard-author").attr("href");window.open(e),contextMenuOff()}function mention(){let e=$("#MessageForm-input").val(),t="@"+$("#"+$("#contextMenu").attr("data-message")).find(".MessageCard-author-name").text().replace(/\s{2,}/g,"").replace(/\s/g,"_").toLowerCase();e.includes(t)||$("#MessageForm-input").val(t+" "+e).focus(),contextMenuOff()}function mentionAll(){let e=$("#MessageForm-input").val();e.includes("@everyone")||$("#MessageForm-input").val("@everyone "+e).focus(),contextMenuOff()}function contextMenu(e){e.preventDefault(),$("#contextMenu").length?$("#contextMenu").attr("data-message",$(e.target).parents(".MessageCard")[0].id):$("body").append(`\n        <div id="contextMenu" data-message="${$(e.target).parents(".MessageCard")[0].id}">\n            ${contextMenuContent}\n        </div>\n        `),clickCoords=getPosition(e),menuWidth=$("#contextMenu").outerWidth()+10,menuHeight=$("#contextMenu").outerHeight()+10,windowWidth=window.innerWidth,windowHeight=window.innerHeight,windowWidth-clickCoords.x<menuWidth?(console.log("out width"),$("#contextMenu").css("left",windowWidth-menuWidth+"px")):$("#contextMenu").css("left",clickCoords.x+"px"),windowHeight-clickCoords.y<menuHeight?$("#contextMenu").css("top",windowHeight-menuHeight+"px"):$("#contextMenu").css("top",clickCoords.y+"px"),$("#contextMenu").fadeIn("fast")}function getPosition(e){var t=0,n=0;if(!e)e=window.event;return e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:t,y:n}}function contextMenuOff(){$("#contextMenu").fadeOut("fast")}function getDate(e,t=!0,n=!1){let s=void 0===e?"":new Date(e.replace(/-/g,"/"));const o=e=>0==e?"":1==e.toString().length?"0"+e:e;return`${s.getDate()} ${months[s.getMonth()]} ${n?`<small>${s.getFullYear()}</small>`:""} ${t?`à ${o(s.getHours())}h${o(s.getMinutes())}`:""}`}function getMessage(e){const t=anchorme({input:e.content,extensions:[{test:/@everyone/gi,transform:e=>`<a href="#">${e}</a>`},{test:/@(?!everyone)(\S|_)+/gi,transform:e=>`<a href="http://escalade-montesquieu.fr/profil/${e.substr(1).replace(/(_)+/gi," ")}">${e}</a>`}]});return`\n    <div class="MessageCard ${e.author==window._username?"myMessage":"theirMessage"}" id="message-${e.id}">\n        <a class="MessageCard-author" href="/profil/${e.author_uuid}" target="blank">\n                <img class="MessageCard-author-img" src="/profil/${e.author_uuid}/img">\n                <h5 class="MessageCard-author-name">\n                    ${e.author}\n                </h5>\n            </a>\n        <p class="MessageCard-text ">\n            ${t}\n        </p>\n        <span class="MessageCard-datetime">${getDate(e.created_at)}</span>\n    </div>\n    `}function addMessage(e){$("#MessagesList").append(getMessage(e)),$(".ForumLayout-messagesList").animate({scrollTop:$(".ForumLayout-messagesList").prop("scrollHeight")},500),$(".MessageCard-author").on("click",contextMenu),$(".MessageCard-author").on("contextmenu",contextMenu)}function addInfo(e){$("#MessagesList").append(e.content),$(".ForumLayout-messagesList").animate({scrollTop:$(".ForumLayout-messagesList").prop("scrollHeight")},500)}function prependMessage(e){const t=$("#MessagesList")[0].scrollHeight;$("#MessagesList").prepend(getMessage(e));var n=$("#MessagesList")[0].scrollHeight-t;$("#MessagesList")[0].scrollTop+=n}function rendMessages(e){e.forEach(e=>{$("#MessagesList").prepend(getMessage(e)),$(".ForumLayout-messagesList").scrollTop($(".ForumLayout-messagesList").prop("scrollHeight"))}),$(".MessageCard-author").on("click",contextMenu),$(".MessageCard-author").on("contextmenu",contextMenu)}function sendMessage(){if(!$("#MessageForm-input").val().match(/\S/gm))return;let e=$("#MessageForm-input");socket.emit("message.new",{content:e.val()}),e.val("")}const sendWritingStart=function(){socket.emit("writing.start")},sendWritingStop=function(){socket.emit("writing.stop"),writeTimeout=null},handleWrite=function(){null==writeTimeout?(socket.emit("writing.start"),clearTimeout(writeTimeout),writeTimeout=setTimeout(sendWritingStop,500)):(clearTimeout(writeTimeout),writeTimeout=setTimeout(sendWritingStop,500))};$(()=>{$("#MessageForm-send").click(sendMessage),$("#MessageForm-input").keyup(function(e){13==e.which?sendMessage():null==writeTimeout?(socket.emit("writing.start"),clearTimeout(writeTimeout),writeTimeout=setTimeout(sendWritingStop,500)):(clearTimeout(writeTimeout),writeTimeout=setTimeout(sendWritingStop,500))}),rendMessages(window._messages),socket.on("connect",()=>{socket.emit("join",{room:window._forum,username:window._username})}),socket.on("messages.update",e=>{"message"==e.type?(window._last_message_author=e.author_uuid,localStorage.setItem(`${window._forum}.last_message`,new Date(e.created_at).getTime()),addMessage(e),socket.emit("seen")):addInfo(e)}),socket.on("writings.update",e=>{console.log(e);const t=e.indexOf(window._username);if(t>-1&&e.splice(t,1),e.length>1){let t=e.splice(0,2);$("#writings").text(`${t.join()} +${e.length} écrivent...`)}else $("#writings").text(0==e.length?"":`${e.join()} écrit...`)}),socket.on("seen.update",e=>{let t=e.indexOf(window._uuid);if(t>-1&&e.splice(t,1),(t=e.indexOf(window._last_message_author))>-1&&e.splice(t,1),e.length>0){let t="";for(let n=0;n<e.length+1&&n<3;n++)t+='<img src="/profil/'+e.shift()+'/img" class="SeenBox-seenTile">';$("#SeenBox").html(`Vu par <div id="SeenBox-seen">${t}</div> ${e.length>0?"+"+e.length:""}`)}else $("#SeenBox").html("")}),window.onunload=window.onbeforeunload=(()=>{socket.emit("leave"),socket.close()}),window.onresize=contextMenuOff,window.onkeyup=function(e){27===e.keyCode&&contextMenuOff()},document.addEventListener("click",function(e){$(e.target).attr("class")&&!$(e.target).attr("class").includes("MessageCard-author")&&(1===(e.which||e.button)&&contextMenuOff())})});
