const publicVapidKey="BH25QhGzdhhFsj8D0Ws71rdpwvW4q_PuqHZRDmZpRoDlItnhRMQ9zvnTT4rfIklgWKxIkFfqqMu49ibGqfiaGlc";function getForumsLastMessages(){axios({method:"get",url:"/message/latests"}).then(e=>{let a=!1;e.data.latests.forEach(e=>{null!==localStorage.getItem(e.forum+".last_message")?(console.log(" "),console.log("Server "+JSON.parse(new Date(e.created_at).getTime())),console.log("Client "+JSON.parse(localStorage.getItem(e.forum+".last_message"))),console.log("or :"),console.log("Server "+e.created_at),console.log("Client "+new Date(JSON.parse(localStorage.getItem(e.forum+".last_message")))),JSON.parse(new Date(e.created_at).getTime())-JSON.parse(localStorage.getItem(e.forum+".last_message"))>2e3?(a=!0,console.log(`${e.forum.split(".")[0]}: nouveaux messages (${e.created_at})`),$(`.link-forum[data-forum="${e.forum.split(".")[0]}"]`).addClass("has-new-messages"),$(`.card-forum[data-forum="${e.forum.split(".")[0]}"]`).addClass("has-new-messages"),a=!0):console.log(`${e.forum.split(".")[0]}: Ã  jour (${e.created_at})`)):($(`.link-forum[data-forum="${e.forum.split(".")[0]}"]`).addClass("has-new-messages"),$(`.card-forum[data-forum="${e.forum.split(".")[0]}"]`).addClass("has-new-messages"),a=!0)}),console.log(a),a&&($(".nav-link-forums").addClass("has-new-messages"),$(".navbar-toggler").addClass("has-new-messages"))})}async function send(){navigator.serviceWorker.register("/js/worker.js").then(onRegistration)}function onRegistration(e){e.waiting&&e.waiting.addEventListener("statechange",onStateChange("waiting",e)),e.installing&&e.installing.addEventListener("statechange",onStateChange("installing",e)),e.active&&e.active.addEventListener("statechange",onStateChange("active",e))}function onStateChange(e,a){return function(t){console.log(`From ${e} to ${t.target.state}`),"activated"==t.target.state&&registerPush(a)}}function registerPush(e){e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:urlBase64ToUint8Array(publicVapidKey)}).then(function(e){console.log("Subscribing"),fetch(`${window._push_host}/subscribe`,{method:"POST",body:JSON.stringify(e),headers:{"content-type":"application/json"}})})}function urlBase64ToUint8Array(e){const a=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(a),s=new Uint8Array(t.length);for(let e=0;e<t.length;++e)s[e]=t.charCodeAt(e);return s}window._push_host="https://api.escalade-montesquieu.fr","serviceWorker"in navigator&&send().catch(e=>console.error(e)),getForumsLastMessages();
